<!DOCTYPE html>  <html> <head>   <title>dust.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="dust.html">                 dust.coffee               </a>                                           <a class="source" href="dust_test.html">                 dust_test.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               dust.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>#</h1>

<p>grunt-dust
https://github.com/vtsvang/grunt-dust</p>

<p>Copyright (c) 2012 Vladimir Tsvang
Licensed under the MIT license.</p>

<h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports = </span><span class="nf">(grunt) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Link to Underscore.js</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_ = </span><span class="nx">grunt</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">_</span>

  <span class="nv">dust = </span><span class="nx">require</span> <span class="s">&#39;dustjs-linkedin&#39;</span>
  <span class="nv">path = </span><span class="nx">require</span> <span class="s">&#39;path&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Path to dust runtime path</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">dustRuntimePath = </span><span class="nx">grunt</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">expandFiles</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;node_modules&#39;</span><span class="p">,</span> <span class="s">&#39;dustjs-linkedin&#39;</span><span class="p">,</span> <span class="s">&#39;dist&#39;</span><span class="p">,</span> <span class="s">&#39;dust-core-*.js&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>==========================================================================</p>

<h1>TASKS</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>Task to compile dustjs templates</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerMultiTask</span> <span class="s">&#39;dust&#39;</span><span class="p">,</span> <span class="s">&#39;Task to compile dustjs templates.&#39;</span><span class="p">,</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Configuration options</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">options = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span>
      <span class="nv">runtime: </span><span class="kc">on</span>
      <span class="nv">relativeFrom: </span><span class="s">&#39;&#39;</span>
      <span class="nv">amd: </span><span class="p">{</span>
        <span class="nv">deps: </span><span class="p">[</span><span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">dustRuntimePath</span><span class="p">)]</span>
      <span class="p">}</span>
    <span class="p">,</span> <span class="nx">@data</span><span class="p">.</span><span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Destination</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">dest = </span><span class="nx">path</span><span class="p">.</span><span class="nx">normalize</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@file</span><span class="p">.</span><span class="nx">dest</span><span class="si">}</span><span class="s">&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Paths list</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">files = </span><span class="nx">grunt</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">expandFiles</span> <span class="nx">@file</span><span class="p">.</span><span class="nx">src</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Compiled files contents</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">all = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Loop through all files and compile them</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">idx</span> <span class="k">in</span> <span class="nx">files</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Read file contents</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">rawContent = </span><span class="nx">grunt</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">read</span> <span class="nx">file</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Determine template file relative path</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">relativePath = </span><span class="nx">grunt</span><span class="p">.</span><span class="nx">helper</span> <span class="s">&#39;dust-relative-path&#39;</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">relativeFrom</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Determine template name</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">tplName = </span><span class="nx">relativePath</span><span class="p">.</span><span class="nx">replace</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span><span class="si">}</span><span class="s">$&quot;</span><span class="p">),</span> <span class="s">&#39;&#39;</span>

      <span class="k">try</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Try to compile current template</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">all</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;// </span><span class="si">#{</span><span class="nx">relativePath</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">dust</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">rawContent</span><span class="p">,</span> <span class="nx">tplName</span>
      <span class="k">catch</span> <span class="nx">e</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Handle error and log it with Grunt.js API</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">grunt</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">error</span><span class="p">().</span><span class="nx">writeln</span> <span class="nx">e</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="nx">grunt</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&quot;DustJS found errors.&quot;</span><span class="p">,</span> <span class="mi">10</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Concatenate</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">rawAll = </span><span class="nx">all</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;\n&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Wrap to the AMD and write to file</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">grunt</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">write</span> <span class="nx">dest</span><span class="p">,</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">amd</span> <span class="k">then</span> <span class="nx">grunt</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="s">&#39;dust-amd&#39;</span><span class="p">,</span> <span class="nx">rawAll</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">amd</span><span class="p">.</span><span class="nx">deps</span><span class="p">)</span> <span class="k">else</span> <span class="nx">rawAll</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Add runtime</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">runtime</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Where to store runtime</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">runtimePath = </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span><span class="p">(</span><span class="nx">dest</span><span class="p">),</span> <span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">dustRuntimePath</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Save runtime to file</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">grunt</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">write</span> <span class="nx">runtimePath</span><span class="p">,</span> <span class="nx">grunt</span><span class="p">.</span><span class="nx">helper</span><span class="p">(</span><span class="s">&#39;dust-runtime&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>==========================================================================</p>

<h1>HELPERS</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h2>Resolves dust-core-<em>.</em>.*.js</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerHelper</span> <span class="s">&#39;dust-runtime&#39;</span><span class="p">,</span> <span class="nf">(file, raw) -&gt;</span>
    <span class="nx">grunt</span><span class="p">.</span><span class="nx">file</span><span class="p">.</span><span class="nx">read</span> <span class="nx">dustRuntimePath</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h2>Wraps some content into AMD</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerHelper</span> <span class="s">&#39;dust-amd&#39;</span><span class="p">,</span> <span class="nf">(content, deps = []) -&gt;</span>
    <span class="s">&quot;define([&#39;</span><span class="si">#{</span><span class="nx">deps</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;\&#39;, \&#39;&#39;</span><span class="si">}</span><span class="s">&#39;], function () {\n\t</span><span class="si">#{</span><span class="nx">content</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;\n&#39;</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;\n\t&#39;</span><span class="p">)</span><span class="si">}</span><span class="s">\n});&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h2>Removing prefix <strong>base</strong> from <strong>fPath</strong> correctly</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerHelper</span> <span class="s">&#39;dust-relative-path&#39;</span><span class="p">,</span> <span class="nf">(fPath, base = &#39;&#39;) -&gt;</span>
    <span class="nv">pathParts = </span><span class="nx">fPath</span><span class="p">.</span><span class="nx">split</span> <span class="nx">path</span><span class="p">.</span><span class="nx">sep</span>
    <span class="nv">baseParts = </span><span class="nx">base</span><span class="p">.</span><span class="nx">split</span> <span class="nx">path</span><span class="p">.</span><span class="nx">sep</span>
    <span class="nv">filtered = </span><span class="p">[]</span>

    <span class="k">if</span> <span class="nx">baseParts</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">filtered = </span><span class="nx">_</span><span class="p">.</span><span class="nx">filter</span> <span class="nx">pathParts</span><span class="p">,</span> <span class="nf">(part, idx) -&gt;</span>
        <span class="nx">part</span> <span class="o">isnt</span> <span class="nx">baseParts</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span>

    <span class="nx">filtered</span><span class="p">.</span><span class="nx">join</span> <span class="nx">path</span><span class="p">.</span><span class="nx">sep</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 